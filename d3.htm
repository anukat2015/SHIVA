<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="d3.v3.min.js"></script>
		<title>D3 Testbed</title>
		<style type="text/css">
		.rounded-corners { -moz-border-radius:8px;-webkit-border-radius:8px;-khtml-border-radius:8px;border-radius:8px;}
		 </style>
  </head>
  <body>
 
 	<div id="containerDiv" style="position:absolute;top:20px;left:20px;height:400px;width:800px"> </div>

  <script type="text/javascript">

/////////////////////////////////////////////////////////////////////////////////////////////////////////
// SETUP
/////////////////////////////////////////////////////////////////////////////////////////////////////////

	var options={}
	options.lSize=11;
	options.lCol="#000000";
	options.trans=250;
	options.nCol="b0c4de";
	options.depth=0;
	options.width=800;
	options.height=400;
	options.chartType="Stream";
	options.sCol="none";
	
	var unselectable={"-moz-user-select":"none","-khtml-user-select":"none",	
		   			  "-webkit-user-select":"none","-ms-user-select":"none",
		   			  "user-select":"none","pointer-events":"none" }

	var con="#containerDiv"														// Holds data
	var firstTime=true;													// If first time
	var id=0;															// Id counter
	var d3Zoom;															// D3 zoom obj
	var maxDepth=0;
	var overTree,selectTree	

	var h=options.height;
	var w=options.width;

	function zoomed(d) {												// ZOOM HANDLER
 		var tp=d3.event.translate;										// Translation
 		var scale=d3.event.scale;										// Scale
  		svgSelect.attr("transform","translate("+tp+") scale("+scale+")");	// Do it
 		} 	

	var svg=d3.select(con)									// Add SVG 
		.append("svg")													// Add SVG shell
		.attr("width",options.width).attr("height",options.height)	// Set size
		.append("g")													// Add group	
	
 			
 				
/////////////////////////////////////////////////////////////////////////////////////////////////////////
// DATA
/////////////////////////////////////////////////////////////////////////////////////////////////////////

	var dataSet=[];
	firstTime=false;													// Been there
 	
 	
 	var format = d3.time.format("%m/%d/%y");

		d3.csv("data1.csv", function(data) {
			_dataSet=[];
			var t=[];
			var o=[];
			for (x in data[0])	o.push(x);
			t.push(o)
			data.forEach(function(d,i) {
				var o=[]
				for (x in d)	o.push(d[x]);
				t.push(o)
				})
			var i,j,n;
			var n=t.length;
			var fn=t[0].length-1;
			for (i=1;i<fn;++i) {								// For each layer
				for (j=1;j<n;++j) {								// For time point
					var o={};									// New obj
					o.key=t[0][i];								// Set field name as key
					o.date=format.parse(t[j][0].replace(/2013/,"13"));			// Set date
					o.value=t[j][i]-0;							// Set value
					dataSet.push(o);							// Add item
					}
				}
		 	redraw();
		})
	
 	
/////////////////////////////////////////////////////////////////////////////////////////////////////////
// DRAW
/////////////////////////////////////////////////////////////////////////////////////////////////////////
		
	function redraw() {												// DRAW

		// NETWORK /////////////////////////////////////////////////////////////////////////////////////////////////////////////////		

		if (options.chartType == "Stream") {							// Stream graph
var datearray = [];
			var colorRange=["#B30000", "#E34A33", "#FC8D59", "#FDBB84", "#FDD49E", "#FEF0D9"];
			var colorSet=d3.scale.ordinal().range(colorRange);			// Scale colorset
			var x=d3.time.scale().range([0,options.width]);				// Scale x
			var y=d3.scale.linear().range([options.height,options.lSize+6]);	// Scale y
	
			var dataBar=d3.select(con)									// Add vertical data bar
		        .append("div")											// Add div
		        .style("position","absolute").style("z-index","19")		// Setup
		        .style("width","1px").style("height","100%")			// Size
		        .style("pointer-events","none")							// No mouse hits
		        .style("top","0px").style("left","0px").style("background","#fff")  // Pos
		    	.style("font-size",options.lSize+"px").style("color",options.lCol).style("font-family","sans-serif")
				.html("<div id='vdat' style='position:absolute;left:-100px;top:4px;width:200px;text-align:center'></div><div id='vnow' style='position:absolute;left:-50px;top:"+options.height+"px;width:100px;text-align:center'></div>")		
			 		
			var stack=d3.layout.stack()									// Create layout
					.offset("silhouette")								// Center the stream
			    	.values(function(d) { return d.values; })			// Get values
			   	 	.x(function(d) { return d.date; })					// Plot date on x axis
			    	.y(function(d) { return d.value; });				// Vaalue on y
			var nest=d3.nest().key(function(d) { return d.key; });		// Nest on keys
			var layers=stack(nest.entries(dataSet));					// Create layers
		
				
			var area = d3.svg.area()
			    .interpolate("cardinal")
			    .x(function(d) { return x(d.date); })
			    .y0(function(d) { return y(d.y0); })
			    .y1(function(d) { return y(d.y0 + d.y); });
			  x.domain(d3.extent(dataSet, function(d) { return d.date; }));
			  y.domain([0, d3.max(dataSet, function(d) { return d.y0 + d.y; })]);
			
				svg.selectAll(".layer")									// Add layers
			      		.data(layers)									// Set data
		    			.enter().append("path")							// Add path
				      	.attr("class","layer")							// Set class
			      		.attr("d", function(d) { return area(d.values); })		// Set position
			      		.style("fill", function(d, i) { return colorSet(i); });	// Set color
			
				 svg.selectAll(".layer")								// Point at layers
						.attr("opacity",1)								//  Assunme fully opaque if mouse is out
						.on("mouseover", function(d,i) {				// On mouse over
				      		svg.selectAll(".layer")						// Point at layers
	      		     		.transition().duration(250)					// Quick transition
				     	 	.attr("opacity", function(d,j) {			// Set opacity
				        		return j != i ? 0.6 : 1;				// If over, set to 1, else .6
				    		})
				   	 	})
		
				.on("mousemove", function(d, i) {						// When hovering over layer
						var date=x.invert(d3.mouse(this)[0]);			// Get time
				      	var now=date.getMonth()+date.getDate();
				      	var selected=(d.values);							
				      	for (var k = 0; k < selected.length; k++) {
				        	datearray[k] = selected[k].date
				        	datearray[k] = datearray[k].getMonth() + datearray[k].getDate();
				      		}
					    mousedate=datearray.indexOf(now);
				      	pro=d.values[mousedate].value;
						d3.select(this).attr("stroke","#000").attr("stroke-width","0.5px")			// Show border
			        	dataBar.style("left",d3.mouse(this)[0]+"px");	// Position data bar
			      		$("#vnow").text(date)
			      		$("#vdat").text(d.key+": "+pro)
			      		dataBar.style("visibility","visible");			// Show data bar
			    		})

			    .on("mouseout", function(d, i) {						// Stop hovering on layer
			     		svg.selectAll(".layer")							// Get all layers
			      			.transition().duration(250)					// Quick transition
			      			.attr("opacity","1");						// Make layer opaque
			      		d3.select(this).attr("stroke-width","0px");		// Add border	
			      		dataBar.style("visibility","hidden");			// Hide data bar
			  			})
			    
			}															// End Stream


/////////////////////////////////////////////////////////////////////////////////////////////////////////
/// STANDARD STUFF
/////////////////////////////////////////////////////////////////////////////////////////////////////////
		
		firstTime=false;												// Not first time thru
		}																// End update






	function trace(msg) { console.log(msg) };

    </script>
  </body>
</html>
